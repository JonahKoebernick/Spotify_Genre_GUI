<!doctype html>
<html>
  <head>
    <title>Example of the Authorization Code flow with Spotify</title>

    <style type="text/css">
      #login, #loggedin {
        display: none;
      }
    
      #playing, #paused {
        display: none;
      }
        
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }
    
      .text-overflow-player {
        overflow: scroll;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 390px;
      }
        
      .button1 {
        border-radius: 50%;
        background-color: #0f0b08;
        border: 1px #1d1c1c;
        color: whitesmoke;
        padding: 5px 10px;
        position: relative;
        width: 110px;
        top:-296px;
      }
      .button1:hover {
        border-radius: 50%;
        background-color: #0f0b08;
        border: 1px #1d1c1c;
        color: whitesmoke;
        padding: 5px 10px;
        position: relative;
        width: 110px;
        outline:none;
        top:-296px;
      }

      .gap-20{
        width:100%;
        height:20px;
      }
        
        .player{
            width: 25%;
            height: auto;
            position: block;
            padding-top: 15px;
            padding-left: 25px;
        }
        
        .player img {
            height: 100%;
            width: 100%;
        }
        
      #myProgress {
        position: relative;
        top: -271px;
        left: 49px;
        width: 85%;
        background-color: #535456;
        border-radius: 25px;
        height: 9px;
      }

      #myBar {
        width: 1%;
        height: 9px;
        background-color: #e3e4e8;
        border-radius: 25px;
      }
      
    </style>
  </head>

  <body style="background-color:#1F1C1C;">
    <div class="container">
      <div id="login">
        <h1>This is an example of the Authorization Code flow</h1>
        <a href="/login" class="btn btn-primary">Log in with Spotify</a>
      </div>
      <div id="loggedin">
          
        <div style="float: left; margin-right: 60px;" class="player">
            <img src="images/player-temp-bg.png" style="border:10px solid #2f2f2f;"/>
            
            <script id="curr-template" type="text/x-handlebars-template">
                <h2 style="position: relative; left:-450px; top:-741px;"><font face="verdana" size="5" color="white"><dd class="text-overflow-player">{{artist}}</dd></font></h2>
                <img style="position: relative; left:-513px; top:-701px;" width="18.2%" src="{{image_url}}" />
                <h2 style="position: relative; left:38px; top:-693px;"><font face="verdana" size="6" color="white"><dd class="text-overflow-player">{{song_name}}</dd></font></h2>
            </script>
            
            <div id="myProgress">
                <div id="myBar"></div>
            </div>
            
            <div style="position: relative; left: 460px; top:-276px;">
                <font face="verdana" size="3" color="#e3e4e8"><p id="length"></p></font>
            </div>
            
            <button style="left:103px;" class=button1 onclick="restart()"><img src="images/btn-prev.png"/></button>
            <button style="left:105px;" class=button1 onclick="pause()"><img id="image" src="images/btn-pause.png"/></button>
            <button style="left:108px;" class=button1 onclick="next_song()"><img src="images/btn-next.png"/></button>
            <button style="left:83px; top:-446px;" class=button1 onclick=""><img src="images/btn-save.png"/></button>
            
        </div>
          
        <div id="user-profile">
        </div>
        <div id="oauth">
        </div>
        <dl class="dl-horizontal">
         
         <dt><font style="position: relative; float: left;" color="white">Pop: </font></dt><dd><input type="number" name="quantity" id="pop_value" min="1" max="100"></dd>
         
         <dt><font style="position: relative; float: left;" color="white">Queen: </font></dt><dd><input type="number" name="quantity"  id="queen_value"min="1" max="100"></dd>
         
         <dt><font style="position: relative; float: left;" color="white">Throw backs: </font></dt><dd><input type="number" name="quantity"  id="tb_value" min="1" max="100"></dd>
         
         <dt><font style="position: relative; float: left;" color="white">Country: </font></dt><dd><input type="number" name="quantity"  id="country_value" min="1" max="100"></dd>
         
         <dt><font style="position: relative; float: left;" color="white">Rock: </font></dt><dd><input type="number" name="quantity"  id="rock_value" min="1" max="100"></dd>
         
         <dt><font style="position: relative; float: left;" color="white">Hip-Hop: </font></dt><dd><input type="number" name="quantity"  id="hiphop_value" min="1" max="100"></dd>
         
         <dt><font style="position: relative; float: left;" color="white">EDM: </font></dt><dd><input type="number" name="quantity"  id="edm_value" min="1" max="100"></dd>
         
         <dt><font style="position: relative; float: left;" color="white">Top Hits </font></dt><dd><input type="number" name="quantity"  id="tophits_value" min="1" max="100"></dd>
         
            <script>pausebutton();</script>
            
        </dl>
        </div>
        <div id="curr">
        </div>
        <div>
<!--            <h2><font face="verdana" size="2" color="#535456"><p id="length"></p></font></h2>-->
        </div>
<!--
        <div id="myProgress">
            <div id="myBar"></div>
        </div>
-->


       
      </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">
      <h1>Logged in as {{display_name}}</h1>
      <div class="media">
        <div class="pull-left">
          <img width="150" src="{{images.0.url}}" />
        </div>
        <div class="media-body">
          <dl class="dl-horizontal">
            <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
            <dt>Id</dt><dd>{{id}}</dd>
            <dt>Email</dt><dd>{{email}}</dd>
            <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
            <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
            <dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
            <dt>Country</dt><dd>{{country}}</dd>
          </dl>
        </div>
      </div>
    </script>

    <script id="oauth-template" type="text/x-handlebars-template">
      <h2>oAuth info</h2>
      <dl class="dl-horizontal">
        <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
        <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
      </dl>
    </script>
        
    <div class="gap-20"></div>    
            
<!--
        <script id="curr-template" type="text/x-handlebars-template">
      <h2><font color="white"><dd class="text-overflow">{{song_name}}</dd></font></h2>
      <h2><font color="white"><dd class="text-overflow">{{artist}}--{{album}}</dd></font></h2>
        <div class="media">            
            <div class="pull-left">        
                <img class="media-object" width="350" src="{{image_url}}" />
            </div>
            <script>pausebutton();</script>
        </div>
-->
        
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

<script>
    function pause() {
        $.ajax({
        url: '/is_playing',

        }).done(function(data) {
            var access_token = data.access_token;
            var is_playing = data.is_playing;
//            alert(is_playing);

            if (is_playing) {
                $.ajax({
                    url: 'https://api.spotify.com/v1/me/player/pause',
                    type: 'PUT',
                    headers: {
                      'Authorization': 'Bearer ' + access_token
                    }

                });
                
                var img = document.getElementById("image");
                img.src="images/btn-play.png";
                return false;
            } else {
                $.ajax({
                    url: 'https://api.spotify.com/v1/me/player/play',
                    type: 'PUT',
                    headers: {
                      'Authorization': 'Bearer ' + access_token
                    }

                });
                
                var img = document.getElementById("image");
                img.src="images/btn-pause.png";
                return false;
            }
            
          });
    }
//<<<<<<< HEAD
</script>

<script>
    function restart() {
        $.ajax({

        }).done(function(data) {
            var access_token = data.access_token;
            var is_playing = data.is_playing;

            $.ajax({
                url: 'https://api.spotify.com/v1/me/player/seek',
                type: 'PUT',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                data: {
                  'position_ms': 0
                }

            });
            
            
          });
    }
//<<<<<<< HEAD
</script>        
        
<script>
    function pausebutton() {
        var is_playing = data.is_playing;
        if (is_playing) {
            var img = document.getElementById("image");
            img.src="images/btn-pause.png";
            return false;
        } else {
            var img = document.getElementById("image");
            img.src="images/btn-play.png";
            return false;
        }
    }
</script>
        
        
<script>
    function next_song() {
  var pop_value = document.getElementById("pop_value").value;
  var queen_value = document.getElementById("queen_value").value;
  var tb_value = document.getElementById("tb_value").value;
  
  var country_value = document.getElementById("country_value").value;
  var hiphop_value = document.getElementById("hiphop_value").value;
  var rock_value = document.getElementById("rock_value").value;
  var edm_value = document.getElementById("edm_value").value;
  var tophits_value = document.getElementById("tophits_value").value;
  /* Treat this information as suspicious and check the values for 1-100, if <1 x=1, if x>100 x=100 */
  
  $.ajax({
        url: '/next_song',
        data : {
        
               'pop_value' : pop_value,
               'queen_value' : queen_value,
               'tb_value' : tb_value,
               'country_value' :  country_value,
               'hiphop_value' : hiphop_value,
               'rock_value'  : rock_value,
               'edm_value' : edm_value,
               'tophits_value' : tophits_value
            
         }
        }).done(function(data) {
         var ulr = data.ulr;
         var amt = data.amt;
         var access_token = data.access_token;
         var rand5 = Math.floor(Math.random() * amt);
         $.ajax({
            url: 'https://api.spotify.com/v1/me/player/play',
            type: 'PUT',
            headers: {
              'Authorization': 'Bearer ' + access_token
            },
            dataType: "json",
            contentType: "application/json",
            data : JSON.stringify({
             "context_uri": "spotify:playlist:"+ulr,
             "offset": {
            "position": rand5
            }
            })
            
          });
         

        });
    }
</script>         
        
<!--=======
  
>>>>>>> refs/remotes/origin/master-->
        
<script>
var timeleft = 1000;
var song_length = 1000;
var flag = 3;
var counter = 20;
var duration_ms = 100;
var progress_ms = 10;
var width = 10;
var elem = document.getElementById("myBar");

var currSource = document.getElementById('curr-template').innerHTML,
            currTemplate = Handlebars.compile(currSource),
            currPlaceholder = document.getElementById('curr');

// Update the count down every 1 second
var x = setInterval(function() {
    if(counter > 10 || timeleft < 25){
    counter = 0;
    $.ajax({
              url: '/track_length'
              
            }).done(function(data) {
              var image = data.image;
              var name = data.name;
              var artist = data.artist;
              var album = data.album;
              duration_ms = data.duration_ms;
              duration_ms = Math.floor(duration_ms/1000);
              
              progress_ms = data.progress_ms;
              progress_ms = Math.floor(progress_ms/1000);
              
              timeleft = duration_ms - progress_ms;
              
                currPlaceholder.innerHTML = currTemplate({
                image_url: image,
                song_name: name,
                artist : artist,
                album : album
              });
             });
             

             
     }else{
     counter = counter+1;
     progress_ms = progress_ms +1;
     timeleft = duration_ms - progress_ms;
     }
     
     
     
    if (width >= 100) {
      width =0;
      elem.style.width = 1 + '%'; 
    } else {
      width= (progress_ms/duration_ms); 
      width = width*100;
      elem.style.width = width + '%'; 
    }
  
  // Time calculations for days, hours, minutes and seconds
  var minutes = Math.floor(timeleft / 60);
  var seconds = timeleft - minutes * 60;
  
    
  // Output the result in an element with id="demo"
  var zerofill ="";
  if(seconds <10){
    zerofill = "0";
    }else{
    zerofill = "";
    }
  document.getElementById("length").innerHTML = minutes + ":" + zerofill + seconds;
    
  // If the count down is over, write some text 
  if (timeleft < 3 && flag >1) {
    counter =15;
    flag =0;    
    next_song();
  }
  flag = flag+1;
  

}, 1000);
</script>


<script>

var y = setInterval(function() {


$.ajax({
              url: '/refresh_token',
              data: {
                'refresh_token': refresh_token
              }
            }).done(function(data) {
              access_token = data.access_token;
              oauthPlaceholder.innerHTML = oauthTemplate({
                access_token: access_token,
                refresh_token: refresh_token
              });
            });






}, 10000);


</script>
    
    <script>
      (function() {

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');

        var oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');

        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

        if (error) {
          alert('There was an error during the authentication');
        } else {
          if (access_token) {
            // render oauth info
            oauthPlaceholder.innerHTML = oauthTemplate({
              access_token: access_token,
              refresh_token: refresh_token
            });

            $.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                  userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                  $('#login').hide();
                  $('#loggedin').show();
                }
            });
          } else {
              // render initial screen
              $('#login').show();
              $('#loggedin').hide();
          }
          

          document.getElementById('obtain-new-token').addEventListener('click', function() {
            $.ajax({
              url: '/refresh_token',
              data: {
                'refresh_token': refresh_token
              }
            }).done(function(data) {
              access_token = data.access_token;
              oauthPlaceholder.innerHTML = oauthTemplate({
                access_token: access_token,
                refresh_token: refresh_token
              });
            });
          }, false);
        }
      })();
    </script>
  </body>
</html>

