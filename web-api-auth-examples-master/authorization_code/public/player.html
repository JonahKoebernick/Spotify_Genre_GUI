<!DOCTYPE html>
<html>
    <style type="text/css">
        .player{
            width: 25%;
            height: auto;
            position: relative;
            padding-top: 2.5%;
            padding-left: 2.5%;
        }  
        
        .player img {
            height: 100%;
            width: 100%;
        }
        
        .player button {
            background-color: transparent;
            border: none;
/*            color: whitesmoke;*/
            position: relative;
        }
        .button1:hover {
/*            background-color: #0f0b08;*/
            border: none;
/*            color: whitesmoke;*/
            position: relative;
            outline:none;
        }
        
        #myProgress {
            position: block;
            left: 7.5%;
            width: 85%;
            background-color: #535456;
            border-radius: 25px;
            height: 5px;
            
            transform: translate(0%, -500%);
        }

        #myBar {
            width: 1%;
            height: 100%;
            background-color: #e3e4e8;
            border-radius: 25px;
        }

        #container {
            width: 73%;
            position: relative;
/*            background: yellow;*/
        }
        
        #song {
            display: inline-block;
            position: relative;
            white-space: nowrap;
/*            background: red;*/
/*            overflow: hidden;*/
        }
        
        #info {
            display: inline-block;
            position: relative;
            white-space: nowrap;
/*            background: red;*/
/*            overflow: hidden;*/
        }
        
        #coverUp {
            position: absolute;
            height: 28px;
            width: 50%;
            background: #1F1C1C;
/*            background-color: blue;*/
            z-index:50;
        }
        
        
    </style>
    
    <body style="background-color:#1F1C1C;">
        <div class="player">
            
            <img src="images/player-temp-bg.png"/>
            
            <script id="curr-template" type="text/x-handlebars-template">
                <h2 style="position: relative; transform: translate(0%,-3900%);"><font face="verdana" size="3.5" color="white"><dd class="text-overflow-player">{{artist}}</dd></font></h2>
<!--                <img style="position: relative; left:13%; width:74%; transform: translate(0%,-228.2%);" src="{{image_url}}"/>-->
                <img style="position: relative; left:13%; width:74%; transform: translate(0%,-275%);" src="{{image_url}}"/>

                <div id="coverUp" style="transform: translate(-86.5%,-2519%);"></div>
                <div id="container" style="transform: translate(10%,-2590%);">
                    <h2 style="position: relative;"><font face="verdana" size="4.5" color="white"><div id="song">{{song_name}}</div></font></h2>
                </div>
                <div id="coverUp" style="width: 150%; transform: translate(48.5%,-2762%);"></div>

                
                <div id="coverUp" style="height: 20px; transform: translate(-86.5%,-3700%);"></div>
                <div id="container" style="transform: translate(10%,-3700%);">
                    <font face="verdana" size="3.5" color="grey"><div id="info" style="position: relative;">{{artist}}, {{album}}</div></font>
                </div>
                <div id="coverUp" style="height: 20px; width: 150%; transform: translate(48.5%,-3800%);"></div>

<!--                <h2 style="position: relative; transform: translate(7%,-3020%);"><font face="verdana" size="4.5" color="white"><div id="song">{{song_name}}</div></font></h2>-->
<!--                <h1 style="position: relative; transform: translate(-3%,-3550%);"><font face="verdana" size="3.5" color="grey"><dd class="text-overflow-player">{{artist}}, {{album}}</dd></font></h1>-->
            </script>

            <div style="transform: translate(10%,-3500%);" id="myProgress">
                <div style="position: relative; height: 100%;" id="myBar"></div>
            </div>

            <div style="position: inherit">                
                <button style="position:absolute; z-index: 100; left: 84.45%; width:8.5%; height: auto; transform: translate(0%,-1120%);" class=button onclick="save()"><img id="save" style="z-index:150;" src="images/btn-sav1.png"/></button>
                <button style="position:relative; left: -1.9%; width:7.5%; transform: translate(0%,-430%);" class=button onclick="shuffle()"><img id="shuffle" src="images/btn-shuffle-off.png"/></button>
                <button style="position:relative; left: 4.7%; width:10.7%; transform: translate(0%,-506%);" class=button onclick="prev_btn()"><img src="images/btn-prev1.png"/></button>
                <button style="position:relative; left: 10.53%; width:20%; transform: translate(0%,-227.5%);" class=button onclick="pause()"><img id="play" src="images/btn-pause1.png"/></button>
                <button style="position:relative; left: 16.6%; width:10.7%; transform: translate(0%,-506%);" class=button onclick="skip()"><img src="images/btn-next1.png"/></button>
                <button style="position:relative; left: 23.2%; width:7.7%; transform: translate(0%,-425%);" class=button onclick="repeat()"><img id="repeat" src="images/btn-repeat-off.png"/></button>
                <font face="verdana" size="2" color="#55ba55"><div id="device_inner" style="position: relative; transform: translate(14%,-860%);">device</div></font>
            </div>
            
            <div style="position: relative; transform: translate(7%,-1540%);">
                <font face="verdana" size="2" color="#e3e4e8"><p id="length_in"></p></font>
            </div>
            
            <div style="position: relative; transform: translate(83%,-1710%);">
                <font face="verdana" size="2" color="#e3e4e8"><p id="length"></p></font>
            </div>
            
            
            
            
            
            
            <div id="curr"></div>
            
        </div>
        
        
        <p>
            <button onclick="history();">History</button>
        </p> 
        

        <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    
        <script>
            function get_at() {
                $.ajax({
                url: '/access_token',

                }).done(function(data) {
                    var at = data.access_token;
                    
                    alert("Access Token: " + at);
                });
            }
        </script>
        
        <script>
            function dev_info() {
                $.ajax({
                url: '/devices',

                }).done(function(data) {
                    var num = data.num;
                    var curr = data.current;
                    var dev_name = curr.name;
                    var type = curr.type;
                    var vol = curr.volume_percent;
                    var dev_list = data.all
                    device_inner.innerHTML = dev_name;
                    
//                    alert("Name: " + dev_name + "\nType: " + type + "\nVolume: " + vol);
//                    alert("id: " + curr.id +
//                          "\nis_active: " + curr.is_active +
//                          "\nis_private_session: " + curr.is_private_session +
//                          "\nis_restricted: " + curr.is_restricted);
                  });
            }
        </script>
        
        <script>
            function history() {
                $.ajax({
                url: '/recent',

                }).done(function(data) {
                    var recent_tracks = data.ten_recent;
                    alert("Recently Played:\n" + 
                                   recent_tracks[0].artists[0].name + " -- " + recent_tracks[0].name
                          + "\n" + recent_tracks[1].artists[0].name + " -- " + recent_tracks[1].name
                          + "\n" + recent_tracks[2].artists[0].name + " -- " + recent_tracks[2].name
                          + "\n" + recent_tracks[3].artists[0].name + " -- " + recent_tracks[3].name
                          + "\n" + recent_tracks[4].artists[0].name + " -- " + recent_tracks[4].name
                          + "\n" + recent_tracks[5].artists[0].name + " -- " + recent_tracks[5].name
                          + "\n" + recent_tracks[6].artists[0].name + " -- " + recent_tracks[6].name
                          + "\n" + recent_tracks[7].artists[0].name + " -- " + recent_tracks[7].name
                          + "\n" + recent_tracks[8].artists[0].name + " -- " + recent_tracks[8].name
                          + "\n" + recent_tracks[9].artists[0].name + " -- " + recent_tracks[9].name);
                });
            }
        </script> 
        
        <script>
            function songScroll() {
//                alert("Running");
                if (document.getElementById("song").clientWidth > document.getElementById("container").clientWidth) {
                    var elem = document.getElementById("song");   
                    var pos = 0;
                    var dir = 0;
                    var id = setInterval(function(){
                        if (dir == 0 && pos > (document.getElementById("container").clientWidth - elem.clientWidth)-5) {
                            pos--;
                            song.style.left = pos + "px"; 
                        } else if (pos == (document.getElementById("container").clientWidth - elem.clientWidth)-5) {
                            dir = 1;
                            pos++;
                            song.style.left = pos + "px"; 
                        } else if (dir == 1 && (document.getElementById("container").clientWidth - elem.clientWidth)-5 < pos && pos < 5) {
                            pos++;
                            song.style.left = pos + "px"; 
                        } else if (pos == 5) {
                            dir = 0;
                            pos--;
                            song.style.left = pos + "px"; 
                        } else if (pos == 10) {
                            clearInterval(id);
                        }
                    }, 40);
                }   
            }
        </script>
        
        <script>
            function infoScroll() {
//                alert("Running");
                if (document.getElementById("info").clientWidth > document.getElementById("container").clientWidth) {
                    var elem = document.getElementById("info");   
                    var pos = 0;
                    var dir = 0;
                    var id = setInterval(function(){
                        if (dir == 0 && pos > (document.getElementById("container").clientWidth - elem.clientWidth)-5) {
                            pos--;
                            info.style.left = pos + "px"; 
                        } else if (pos == (document.getElementById("container").clientWidth - elem.clientWidth)-5) {
                            dir = 1;
                            pos++;
                            info.style.left = pos + "px"; 
                        } else if (dir == 1 && (document.getElementById("container").clientWidth - elem.clientWidth)-5 < pos && pos < 5) {
                            pos++;
                            info.style.left = pos + "px"; 
                        } else if (pos == 5) {
                            dir = 0;
                            pos--;
                            info.style.left = pos + "px"; 
                        } else if (pos == 10) {
                            clearInterval(id);
                        }
                    }, 40);
                }   
            }
        </script>
        
        <script>
            function pause() {
                $.ajax({
                url: '/is_playing',

                }).done(function(data) {
                    var access_token = data.access_token;
                    var is_playing = data.is_playing;

                    if (is_playing) {
                        $.ajax({
                            url: 'https://api.spotify.com/v1/me/player/pause',
                            type: 'PUT',
                            headers: {
                              'Authorization': 'Bearer ' + access_token
                            }
                        });

                        var img = document.getElementById("play");
                        img.src="images/btn-play1.png";
                        return false;
                    } else {
                        $.ajax({
                            url: 'https://api.spotify.com/v1/me/player/play',
                            type: 'PUT',
                            headers: {
                              'Authorization': 'Bearer ' + access_token
                            }
                        });

                        var img = document.getElementById("play");
                        img.src="images/btn-pause1.png";
                        return false;
                    }
                  });
            }
        </script>

        <script>
            function prev_btn() {
                $.ajax({
                    url: '/time',

                }).done(function(data) {
                    var time = data.progress_ms;
//                    alert(time);
                    if (time > 10000) {
                        restart();
                    } else {
                        prev();
                    }
                    
                });
            }
        </script>
        
        <script>
            function prev() {
                $.ajax({
                    url: '/access_token',

                }).done(function(data) {
                    var at = data.access_token;
                    
                    $.ajax({
                        url: 'https://api.spotify.com/v1/me/player/previous',
                        type: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + at },
                        dataType: "json",

                    });
                });
                
            }
        </script>        
        
        <script>
            function restart() {
                $.ajax({
                    url: '/access_token',

                }).done(function(data) {
                    var at = data.access_token;
                    
                    $.ajax({
                        url: 'https://api.spotify.com/v1/me/player/seek?position_ms=0',
                        type: 'PUT',
                        headers: {
                            'Authorization': 'Bearer ' + at,
                        },
                        dataType: "json",
                    });
                });
            }
        </script>
        
        <script>
            function pausebutton() {
                var is_playing = data.is_playing;
                if (is_playing) {
                    var img = document.getElementById("play");
                    img.src="images/btn-pause1.png";
                    return false;
                } else {
                    var img = document.getElementById("play");
                    img.src="images/btn-play1.png";
                    return false;
                }
            }    
        </script>
        
        <script>
            function save() {
                var img = document.getElementById("save");
                img.src="images/btn-saved1.png";
                return false;
            }
        </script>
        
        <script>
            function shuffle() {
                var img = document.getElementById("shuffle");
                img.src="images/btn-shuffle-on.png";
                return false;
            }
        </script>
        
        <script>
            function repeat() {
                var img = document.getElementById("repeat");
                img.src="images/btn-repeat-on.png";
                return false;
            }
        </script>
          
        <script>
            function next_song() {
                var pop_value = document.getElementById("pop_value").value;
                var queen_value = document.getElementById("queen_value").value;
                var tb_value = document.getElementById("tb_value").value;

                var country_value = document.getElementById("country_value").value;
                var hiphop_value = document.getElementById("hiphop_value").value;
                var rock_value = document.getElementById("rock_value").value;
                var edm_value = document.getElementById("edm_value").value;
                var tophits_value = document.getElementById("tophits_value").value;
                /* Treat this information as suspicious and check the values for 1-100, if <1 x=1, if x>100 x=100 */

                $.ajax({
                    url: '/next_song',
                    data : {
                        'pop_value' : pop_value,
                        'queen_value' : queen_value,
                        'tb_value' : tb_value,
                        'country_value' :  country_value,
                        'hiphop_value' : hiphop_value,
                        'rock_value'  : rock_value,
                        'edm_value' : edm_value,
                        'tophits_value' : tophits_value
                    }
                }).done(function(data) {
                    var ulr = data.ulr;
                    var amt = data.amt;
                    var access_token = data.access_token;
                    var rand5 = Math.floor(Math.random() * amt);
                    $.ajax({
                        url: 'https://api.spotify.com/v1/me/player/play',
                        type: 'PUT',
                        headers: {
                            'Authorization': 'Bearer ' + access_token
                        },
                        dataType: "json",
                        contentType: "application/json",
                        data : JSON.stringify({
                            "context_uri": "spotify:playlist:"+ulr,
                            "offset": {
                                "position": rand5
                            }
                        })
                    });
                });
            }
        </script>   
        
        <script>
            function skip() {
                $.ajax({
                    url: '/access_token',

                }).done(function(data) {
                    var at = data.access_token;
                    
                    $.ajax({
                        url: 'https://api.spotify.com/v1/me/player/next',
                        type: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + at },
                        dataType: "json",

                    });
                });   
            }
        </script> 
                
        <script>
            var timeleft = 1000;
            var song_length = 1000;
            var flag = 3;
            var counter = 20;
            var duration_ms = 100;
            var progress_ms = 10;
            var width = 10;
            var elem = document.getElementById("myBar");

            var currSource = document.getElementById('curr-template').innerHTML,
            currTemplate = Handlebars.compile(currSource),
            currPlaceholder = document.getElementById('curr');

            // Update the count down every 1 second
            var x = setInterval(function() {
                if(counter > 10 || timeleft < 25){
                    counter = 0;
                    $.ajax({
                        url: '/track_length'
                        
                    }).done(function(data) {
                        var image = data.image;
                        var name = data.name;
                        var artist = data.artist;
                        var album = data.album;
                        var info = artist + " • " + album;
//                        alert(info);
                        duration_ms = data.duration_ms;
                        duration_ms = Math.floor(duration_ms/1000);
                        
                        progress_ms = data.progress_ms;
                        progress_ms = Math.floor(progress_ms/1000);
                        
                        timeleft = duration_ms - progress_ms;

                        currPlaceholder.innerHTML = currTemplate({
                            image_url: image,
                            song_name: name,
                            artist : artist,
                            album : album
                        });
                    });

                }else{
                    
                    counter = counter+1;
                    progress_ms = progress_ms +1;
                    timeleft = duration_ms - progress_ms;
                }

                if (width >= 100) {
                    width =0;
                    elem.style.width = 1 + '%'; 
                } else {
                    width= (progress_ms/duration_ms); 
                    width = width*100;
                    elem.style.width = width + '%'; 
                }

                // Time calculations for days, hours, minutes and seconds
                var minutes = Math.floor(timeleft / 60);
                var seconds = timeleft - minutes * 60;
                
                var minutes_in = Math.floor(progress_ms / 60);
                var seconds_in = progress_ms - minutes_in * 60;

                // Output the result in an element with id="demo"
                var zerofill ="";
                if(seconds <10){
                    zerofill = "0";
                }else{
                    zerofill = "";
                }
                
                var zerofill_in ="";
                if(seconds_in <10){
                    zerofill_in = "0";
                }else{
                    zerofill_in = "";
                }
                
                document.getElementById("length").innerHTML = "-" + minutes + ":" + zerofill + seconds;
                document.getElementById("length_in").innerHTML = minutes_in + ":" + zerofill_in + seconds_in;

                // If the count down is over, write some text 
                if (timeleft < 3 && flag >1) {
                    counter =15;
                    flag =0;    
                    next_song();
                }
                
                flag = flag+1;
            }, 1000);
        </script>

        <script>
            var y = setInterval(function() {
                $.ajax({
                    url: '/refresh_token',
                    data: {
                        'refresh_token': refresh_token
                    }
                }).done(function(data) {
                    access_token = data.access_token;
                    oauthPlaceholder.innerHTML = oauthTemplate({
                        access_token: access_token,
                        refresh_token: refresh_token
                    });
                });
            }, 10000);
        </script>
    
        <script>
            (function() {
                /**
                * Obtains parameters from the hash of the URL
                * @return Object
                */
                function getHashParams() {
                    var hashParams = {};
                    var e, r = /([^&;=]+)=?([^&;]*)/g,
                        
                    q = window.location.hash.substring(1);
                    
                    while ( e = r.exec(q)) {
                        hashParams[e[1]] = decodeURIComponent(e[2]);
                    }
                    return hashParams;
                }

                var userProfileSource = document.getElementById('user-profile-template').innerHTML,
                userProfileTemplate = Handlebars.compile(userProfileSource),
                userProfilePlaceholder = document.getElementById('user-profile');

                var oauthSource = document.getElementById('oauth-template').innerHTML,
                oauthTemplate = Handlebars.compile(oauthSource),
                oauthPlaceholder = document.getElementById('oauth');

                var params = getHashParams();

                var access_token = params.access_token,
                refresh_token = params.refresh_token,
                error = params.error;

                if (error) {
                    alert('There was an error during the authentication');
                    
                } else {
                    
                    if (access_token) {
                        // render oauth info
                        oauthPlaceholder.innerHTML = oauthTemplate({
                            access_token: access_token,
                            refresh_token: refresh_token
                        });

                        $.ajax({
                            url: 'https://api.spotify.com/v1/me',
                            headers: {
                                'Authorization': 'Bearer ' + access_token
                            },
                            success: function(response) {
                                userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                                $('#login').hide();
                                $('#loggedin').show();
                            }
                        });
                    } else {
                    // render initial screen
                        $('#login').show();
                        $('#loggedin').hide();
                    }

                    document.getElementById('obtain-new-token').addEventListener('click', function() {
                    
                        $.ajax({
                            url: '/refresh_token',
                            data: {
                                'refresh_token': refresh_token
                            }
                        }).done(function(data) {
                            access_token = data.access_token;
                            oauthPlaceholder.innerHTML = oauthTemplate({
                                access_token: access_token,
                                refresh_token: refresh_token
                            });
                        });
                    }, false);
                }
            })();
        </script>
        
        <div><script>setTimeout(songScroll, 2500);</script></div>
        <div><script>setTimeout(infoScroll, 2500);</script></div>
        <div><script>setTimeout(dev_info, 0);</script></div>
    </body>
</html>